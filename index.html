<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <!-- Sidebar / Dock -->
    <aside id="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div>
      <div class="cats-loading">–ó–∞—Ä–µ–∂–¥–∞–º –º–µ–Ω—é...</div>
    </aside>

    <!-- Main -->
    <main id="main">
      <div class="top">
        <div class="left-actions">
          <!-- –ù–∞ –¥–µ—Å–∫—Ç–æ–ø —Å–ª—É–∂–∏ –∑–∞ —Å–≤–∏–≤–∞–Ω–µ/—Ä–∞–∑–≥—ä–≤–∞–Ω–µ –Ω–∞ sidebar -->
          <button id="collapseToggle" class="icon-btn desktop-only" title="–°–≤–∏–π/—Ä–∞–∑–≥—ä—Ä–Ω–∏">‚ü®‚ü©</button>
        </div>
        <h2 class="headline">–ü–æ—Å–ª–µ–¥–Ω–∏ –Ω–æ–≤–∏–Ω–∏</h2>
      </div>

      <div id="status" class="status"></div>

      <!-- –§–∏–ª—Ç—Ä–∏ -->
      <section class="filters">
        <div class="time-filters scroller">
          <button class="chip" data-filter="today">–î–Ω–µ—Å</button>
          <button class="chip" data-filter="week">–¢–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</button>
          <button class="chip" data-filter="month">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</button>
          <button class="chip active" data-filter="all">–í—Å–∏—á–∫–∏</button>
        </div>
        <div class="category-filter">
          <label for="categorySelect" class="cat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categorySelect">
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>
      </section>

      <!-- –°–ø–∏—Å—ä–∫ -->
      <div id="list" class="list">
        <div class="placeholder">–ò–∑–ø–æ–ª–∑–≤–∞–π –º–µ–Ω—é—Ç–æ —Å –∏–∫–æ–Ω–∫–∏—Ç–µ, –∑–∞ –¥–∞ –∑–∞—Ä–µ–¥–∏—à –Ω–æ–≤–∏–Ω–∏.</div>
      </div>
    </main>
  </div>

  <!-- Reader -->
  <div id="reader" class="reader" style="display:none" aria-hidden="true">
    <div class="reader-backdrop"></div>
    <div class="reader-panel">
      <div class="reader-bar">
        <div class="reader-title">–ß–µ—Ç–µ—Ü</div>
        <button id="readerClose" class="btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
      </div>
      <div id="readerContent" class="reader-content"></div>
    </div>
  </div>

<script>
/* ===== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===== */
const DEFAULT_ICON = 'https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4f0.svg'; // üì∞
const SELECTORS = 'div.card.pt-4.pb-4.ad0, div.card.pt-4.pb-4.ad3';

/* ===== –ü–æ–º–æ—â–Ω–∏ ===== */
const $ = s => document.querySelector(s);
const statusEl = $('#status'), listEl = $('#list'), sidebarEl = $('#sidebar'), mainEl = $('#main');

function setStatus(msg){ statusEl.textContent = msg || ''; }
function clearList(){ listEl.innerHTML=''; }
function placeholder(msg){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML=msg; listEl.appendChild(d); }
function parseHTML(h){ return new DOMParser().parseFromString(h,'text/html'); }
function absURL(base, rel){ try { return new URL(rel, base).href } catch { return rel } }
function sanitize(node){ node.querySelectorAll('script,style,iframe,object,embed,noscript').forEach(n=>n.remove()); return node; }
function fixRelativeURLs(node, baseHref){
  node.querySelectorAll('[href]').forEach(a=> a.setAttribute('href', absURL(baseHref, a.getAttribute('href'))));
  node.querySelectorAll('[src]').forEach(el=> el.setAttribute('src', absURL(baseHref, el.getAttribute('src'))));
  node.querySelectorAll('[srcset]').forEach(el=>{
    const parts=(el.getAttribute('srcset')||'').split(',').map(s=>s.trim()).filter(Boolean);
    el.setAttribute('srcset', parts.map(p=>{const [u,d]=p.split(/\s+/); return absURL(baseHref,u)+(d?(' '+d):'')}).join(', '));
  });
  return node;
}

/* ===== JSON-LD extractor ===== */
function extractArticleFromLdJson(html){
  const scripts = html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi) || [];
  const pickDate = o => o?.dateModified || o?.datePublished || null;

  const tryOne = obj => {
    if (!obj || typeof obj !== 'object') return null;
    if (obj.articleBody) return { body: obj.articleBody, date: pickDate(obj) };
    if (Array.isArray(obj)) { for (const it of obj) { const r = tryOne(it); if (r) return r; } }
    if (obj['@graph']) return tryOne(obj['@graph']);
    if (obj.mainEntityOfPage) return tryOne(obj.mainEntityOfPage);
    return null;
  };

  for (const tag of scripts) {
    try {
      const jsonText = tag.match(/<script[^>]*>([\s\S]*?)<\/script>/i)[1];
      const data = JSON.parse(jsonText);
      const found = tryOne(data);
      if (found) return found;
    } catch {}
  }
  return null;
}

/* ===== –ü–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫ ===== */
function selectRawBlocks(doc){
  return Array.from(doc.querySelectorAll(SELECTORS));
}

function toCardElement(rawHTML, baseHref){
  const fragDoc = parseHTML('<div id="wrap">'+rawHTML+'</div>');
  const wrap = fragDoc.getElementById('wrap');
  sanitize(wrap);
  fixRelativeURLs(wrap, baseHref);

  // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
  const img = wrap.querySelector('img');
  const imgSrc = img?.getAttribute('src') || '';

  // –∑–∞–≥–ª–∞–≤–∏–µ
  const h = wrap.querySelector('h1,h2,h3');
  const title = (h?.textContent || wrap.querySelector('a[href]')?.textContent || wrap.textContent || '(–±–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ)').trim();

  // –ª–∏–Ω–∫
  const rawLink = (h?.querySelector('a[href]')?.getAttribute('href')) || wrap.querySelector('a[href]')?.getAttribute('href') || '';
  const linkAbs = rawLink ? absURL(baseHref, rawLink) : '';

  // –¥–∞—Ç–∞
  let isoDate = '', formattedDate = '';
  const t = wrap.querySelector('time[datetime]') || wrap.querySelector('meta[property="article:published_time"]');
  const dateText = t ? (t.getAttribute('datetime') || t.content || '') : '';
  if (dateText) {
    const d = new Date(dateText);
    if (!isNaN(d)) { isoDate = d.toISOString(); formattedDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'}); }
  }

  // –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Ç breadcrumb
  const breadcrumb = wrap.querySelector('li.breadcrumb-item.d-lg-inline.mb-1');
  const category = breadcrumb ? breadcrumb.textContent.trim() : '';

  // –∏–∑—Ç–æ—á–Ω–∏–∫
  let source = ''; try { source = new URL(baseHref).hostname.replace(/^www\./,''); } catch {}

  // —Ä–µ–Ω–¥–µ—Ä
  const card = document.createElement('div');
  card.className='card-row';
  if (isoDate) card.dataset.date = isoDate;
  if (category) card.dataset.category = category;
  if (linkAbs) card.dataset.href = linkAbs;

  card.innerHTML = `
    <div class="thumb">${imgSrc?`<img src="${imgSrc}" alt="">`:'<span>no image</span>'}</div>
    <div class="right-side">
      <div class="header-row">
        <h3 class="title"><a href="#">${title}</a></h3>
        ${formattedDate?`<div class="meta-date">üïí ${formattedDate}</div>`:''}
      </div>
      <div class="meta">${source}${category?` ‚Ä¢ ${category}`:''}</div>
    </div>`;

  card.querySelector('a').addEventListener('click', e=>{
    e.preventDefault();
    const href = card.dataset.href || '';
    if (!href) { setStatus('‚ùå –õ–∏–ø—Å–≤–∞ –ª–∏–Ω–∫ –∫—ä–º —Å—Ç–∞—Ç–∏—è.'); return; }
    openReader(href);
  });

  return card;
}

async function importURL(url){
  if(!url){ setStatus('–ù–µ–≤–∞–ª–∏–¥–µ–Ω URL.'); return; }
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º –Ω–æ–≤–∏–Ω–∏‚Ä¶');
  try{
    const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res  = await fetch(prox, {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const html = await res.text();
    const doc  = parseHTML(html);
    renderCardsFromDoc(doc, url);
    setStatus('');
  }catch(e){ setStatus('‚ùå CORS/HTTP –≥—Ä–µ—à–∫–∞: '+e.message); }
}

function renderCardsFromDoc(doc, baseHref){
  const raw = selectRawBlocks(doc);
  clearList();
  if(!raw.length){ placeholder('–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –µ–ª–µ–º–µ–Ω—Ç–∏.'); return; }
  raw.forEach(node => listEl.appendChild(toCardElement(node.outerHTML, baseHref)));
  populateCategories();
}

/* ===== Sidebar / Dock ===== */
async function loadSidebar(){
  try{
    const html = await fetch('sidebar.html').then(r=>r.text());
    sidebarEl.innerHTML = html;

    // –∏–Ω–∂–µ–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ favicon (–∏–ª–∏ default)
    sidebarEl.querySelectorAll('[data-url]').forEach(el=>{
      el.classList.add('cat');
      const labelText = (el.textContent||'').trim();
      el.innerHTML = '';
      const iconUrl = el.getAttribute('data-icon') || DEFAULT_ICON;
      const img = document.createElement('img');
      img.className = 'fav'; img.alt=''; img.referrerPolicy='no-referrer'; img.src = iconUrl;
      const span = document.createElement('span'); span.className='label'; span.textContent = labelText;
      el.append(img, span);
      el.title = labelText || el.getAttribute('data-url') || '';
    });

    // –∫–ª–∏–∫ –ø–æ –∏–∑—Ç–æ—á–Ω–∏–∫
    sidebarEl.addEventListener('click', e=>{
      const btn = e.target.closest('[data-url]');
      if(!btn) return;
      importURL(btn.dataset.url);
    });

  }catch{
    sidebarEl.innerHTML = '<div class="placeholder">‚ùå –ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è sidebar.html</div>';
  }
}
loadSidebar();

/* ===== –°–≤–∏–≤–∞–Ω–µ/—Ä–∞–∑–≥—ä–≤–∞–Ω–µ –Ω–∞ sidebar (–¥–µ—Å–∫—Ç–æ–ø) ===== */
const collapseBtn = $('#collapseToggle');
if (collapseBtn) {
  collapseBtn.addEventListener('click', ()=>{
    document.body.classList.toggle('sidebar-collapsed');
  });
}

/* ===== Reader ===== */
function splitIntoSentenceParagraphs(text, groupSize = 3){
  const sentenceRegex = /[^.!?]+[.!?]+["']?\s*/g;
  const sentences = text.match(sentenceRegex) || [text];
  const groups = [];
  for (let i = 0; i < sentences.length; i += groupSize) {
    const group = sentences.slice(i, i + groupSize).join(' ').trim();
    if (group) groups.push(group);
  }
  return groups;
}

const reader = $('#reader'), readerContent = $('#readerContent');
$('#readerClose').addEventListener('click', ()=>{ reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; });
reader.addEventListener('click', e=>{ if(e.target.classList.contains('reader-backdrop')){ reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; } });

function extractArticleFromMain(doc){
  const main = doc.querySelector('article, .article, .post-content, [itemprop="articleBody"]');
  if (main){ sanitize(main); return main.innerText.trim(); }
  return '';
}

async function openReader(url){
  if (!url) { setStatus('‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω URL –∑–∞ —Å—Ç–∞—Ç–∏—è.'); return; }
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º —Å—Ç–∞—Ç–∏—è‚Ä¶');
  try{
    const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res  = await fetch(prox, { mode:'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const html = await res.text();
    const doc  = parseHTML(html);

    // JSON-LD
    const fromLd = extractArticleFromLdJson(html);
    let articleText = fromLd?.body || '';
    let dateText    = fromLd?.date || '';

    // fallback
    if (!articleText) articleText = extractArticleFromMain(doc);

    // –¥–∞—Ç–∞ fallback
    if (!dateText) {
      const t = doc.querySelector('time[datetime], meta[property="article:published_time"]');
      dateText = t ? (t.getAttribute?.('datetime') || t.content || '') : '';
    }
    let fDate = '';
    if (dateText) {
      const d = new Date(dateText);
      if (!isNaN(d)) fDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'});
    }

    // –∫–æ—Ä–∏—Ü–∞
    const pic = doc.querySelector('picture.img--title.landscape, article picture, .article picture, figure picture');
    const imgHTML = pic ? pic.outerHTML : '';

    if (articleText) {
      const paras = splitIntoSentenceParagraphs(articleText, 3);
      readerContent.innerHTML = `${imgHTML}${fDate?`<div class="reader-date">üïí ${fDate}</div>`:''}${paras.map((p,i)=>`<p class="${i===0?'lead':''}">${p}</p>`).join('')}`;
      reader.style.display='block';
      reader.setAttribute('aria-hidden','false');
      setStatus('');
    } else {
      setStatus('‚ùå –ù–µ —É—Å–ø—è—Ö –¥–∞ –∏–∑–≤–ª–µ–∫–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞.');
    }
  }catch(e){
    setStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: '+e.message);
  }
}

/* ===== –§–∏–ª—Ç—Ä–∏ –ø–æ –≤—Ä–µ–º–µ ===== */
document.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); applyDateFilter(b.dataset.filter);
}));
function applyDateFilter(f){
  const now=new Date();
  document.querySelectorAll('.card-row').forEach(c=>{
    const dStr=c.dataset.date; if(!dStr){ c.style.display=''; return; }
    const d=new Date(dStr); let show=true;
    if(f==='today') show = d.toDateString()===now.toDateString();
    else if(f==='week') show = (now-d)/(1000*60*60*24)<=7;
    else if(f==='month') show = (now-d)/(1000*60*60*24)<=31;
    c.style.display = show ? '' : 'none';
  });
}

/* ===== –§–∏–ª—Ç—ä—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ===== */
const catSel=$('#categorySelect');
function populateCategories(){
  const cats=new Set();
  document.querySelectorAll('.card-row[data-category]').forEach(c=>{ if(c.dataset.category) cats.add(c.dataset.category); });
  catSel.innerHTML='<option value="all">–í—Å–∏—á–∫–∏</option>'+[...cats].sort().map(c=>`<option>${c}</option>`).join('');
}
catSel.addEventListener('change',()=>{
  const sel=catSel.value;
  document.querySelectorAll('.card-row').forEach(c=>{
    c.style.display=(sel==='all'||c.dataset.category===sel)?'':'none';
  });
});

/* ===== –°–∫—Ä–∏–π ‚Äû–ü–æ—Å–ª–µ–¥–Ω–∏ –Ω–æ–≤–∏–Ω–∏‚Äú –ø—Ä–∏ —Å–∫—Ä–æ–ª –Ω–∞–¥–æ–ª—É ===== */
let lastScrollTop = 0;
mainEl.addEventListener('scroll', ()=>{
  const st = mainEl.scrollTop;
  if (st > lastScrollTop && st > 30) document.body.classList.add('scrolling-down');
  else document.body.classList.remove('scrolling-down');
  lastScrollTop = st <= 0 ? 0 : st;
});
</script>
</body>
</html>