<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</title>

<link rel="stylesheet" href="style.css">

<!-- PWA (–ø–æ –∂–µ–ª–∞–Ω–∏–µ) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1418">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <div class="app">
    <!-- Sidebar (–∑–∞—Ä–µ–∂–¥–∞ sidebar.html) -->
    <aside id="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div>
      <div class="cats-loading">–ó–∞—Ä–µ–∂–¥–∞–º –º–µ–Ω—é...</div>
    </aside>

    <main id="main">
      <!-- Top bar -->
      <div class="top">
        <div class="left-actions">
          <button id="menuToggle" class="icon-btn" aria-label="–û—Ç–≤–æ—Ä–∏ –º–µ–Ω—é">‚ò∞</button>
          <button id="collapseToggle" class="icon-btn desktop-only" aria-label="–°–≤–∏–π/—Ä–∞–∑–≥—ä—Ä–Ω–∏ –º–µ–Ω—é" title="–°–≤–∏–π/—Ä–∞–∑–≥—ä—Ä–Ω–∏ –º–µ–Ω—é">‚ü®‚ü©</button>
        </div>
        <h2 class="headline">–ü–æ—Å–ª–µ–¥–Ω–∏ –Ω–æ–≤–∏–Ω–∏</h2>
      </div>

      <div id="status" class="status"></div>

      <!-- Filters -->
      <section class="filters">
        <div class="time-filters scroller">
          <button class="chip" data-filter="today">–î–Ω–µ—Å</button>
          <button class="chip" data-filter="week">–¢–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</button>
          <button class="chip" data-filter="month">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</button>
          <button class="chip active" data-filter="all">–í—Å–∏—á–∫–∏</button>
        </div>
        <div class="category-filter">
          <label for="categorySelect" class="cat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categorySelect">
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>
      </section>

      <!-- News list -->
      <div id="list" class="list">
        <div class="placeholder">
          –ò–∑–ø–æ–ª–∑–≤–∞–π <b>–º–µ–Ω—é—Ç–æ</b> –æ—Ç–ª—è–≤–æ, –∑–∞ –¥–∞ –∑–∞—Ä–µ–¥–∏—à –Ω–æ–≤–∏–Ω–∏.
        </div>
      </div>
    </main>
  </div>

  <!-- Reader -->
  <div id="reader" class="reader" style="display:none" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="reader-backdrop"></div>
    <div class="reader-panel">
      <div class="reader-bar">
        <div class="reader-title">–ß–µ—Ç–µ—Ü</div>
        <div class="reader-actions">
          <button id="readerClose" class="btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
      <div id="readerContent" class="reader-content"></div>
    </div>
  </div>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const statusEl = $('#status'), listEl = $('#list'), sidebarEl = $('#sidebar'), mainEl = $('#main');
function setStatus(msg){ statusEl.textContent = msg || ''; }
function clearList(){ listEl.innerHTML=''; }
function placeholder(msg){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML=msg; listEl.appendChild(d); }
function parseHTML(html){ return new DOMParser().parseFromString(html,'text/html'); }
function absURL(base, rel){ try{ return new URL(rel, base).href }catch{ return rel } }
function sanitize(node){ node.querySelectorAll('script,style,iframe,object,embed,noscript').forEach(n=>n.remove()); return node; }
function fixRelativeURLs(node, baseHref){
  node.querySelectorAll('[href]').forEach(a=> a.setAttribute('href', absURL(baseHref, a.getAttribute('href'))));
  node.querySelectorAll('[src]').forEach(el=> el.setAttribute('src', absURL(baseHref, el.getAttribute('src'))));
  node.querySelectorAll('[srcset]').forEach(el=>{
    const parts=(el.getAttribute('srcset')||'').split(',').map(s=>s.trim()).filter(Boolean);
    el.setAttribute('srcset', parts.map(p=>{const [u,d]=p.split(/\s+/); return absURL(baseHref,u)+(d?(' '+d):'')}).join(', '));
  });
  return node;
}

/* ===== JSON-LD extractor (–≤–∫–ª. @graph) ===== */
function extractArticleFromLdJson(html){
  const scripts = html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi) || [];
  const pickDate = o => o?.dateModified || o?.datePublished || null;

  const tryOne = obj => {
    if (!obj || typeof obj !== 'object') return null;
    if (obj.articleBody) return { body: obj.articleBody, date: pickDate(obj) };
    if (Array.isArray(obj)) { for (const it of obj) { const r = tryOne(it); if (r) return r; } }
    if (obj['@graph']) return tryOne(obj['@graph']);
    if (obj.mainEntityOfPage) return tryOne(obj.mainEntityOfPage);
    return null;
  };

  for (const tag of scripts) {
    try {
      const jsonText = tag.match(/<script[^>]*>([\s\S]*?)<\/script>/i)[1];
      const data = JSON.parse(jsonText);
      const found = tryOne(data);
      if (found) return found;
    } catch {}
  }
  return null;
}

/* ===== –ü–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ —Å–ø–∏—Å—ä–∫ ===== */
function selectRawBlocks(doc){
  return Array.from(doc.querySelectorAll('div.card.pt-4.pb-4.ad0, div.card.pt-4.pb-4.ad3'));
}

function toCardElement(rawHTML, baseHref){
  const fragDoc = parseHTML('<div id="wrap">'+rawHTML+'</div>');
  const wrap = fragDoc.getElementById('wrap');
  sanitize(wrap);
  fixRelativeURLs(wrap, baseHref);

  const img = wrap.querySelector('img');
  const imgSrc = img?.getAttribute('src') || '';

  const h = wrap.querySelector('h1,h2,h3');
  const title = (h?.textContent || wrap.querySelector('a[href]')?.textContent || wrap.textContent || '(–±–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ)').trim();

  const rawLink = (h?.querySelector('a[href]')?.getAttribute('href')) || wrap.querySelector('a[href]')?.getAttribute('href') || '';
  const linkAbs = rawLink ? absURL(baseHref, rawLink) : '';

  let isoDate = '', formattedDate = '';
  const t = wrap.querySelector('time[datetime]') || wrap.querySelector('meta[property="article:published_time"]');
  const dateText = t ? (t.getAttribute('datetime') || t.content || '') : '';
  if (dateText) {
    const d = new Date(dateText);
    if (!isNaN(d)) { isoDate = d.toISOString(); formattedDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'}); }
  }

  const breadcrumb = wrap.querySelector('li.breadcrumb-item.d-lg-inline.mb-1');
  const category = breadcrumb ? breadcrumb.textContent.trim() : '';

  let source = ''; try { source = new URL(baseHref).hostname.replace(/^www\./,''); } catch {}

  const card = document.createElement('div');
  card.className='card-row';
  if (isoDate) card.dataset.date = isoDate;
  if (category) card.dataset.category = category;
  if (linkAbs) card.dataset.href = linkAbs;

  card.innerHTML = `
    <div class="thumb">${imgSrc?`<img src="${imgSrc}" alt="">`:'<span>no image</span>'}</div>
    <div class="right-side">
      <div class="header-row">
        <h3 class="title"><a href="#">${title}</a></h3>
        ${formattedDate?`<div class="meta-date">üïí ${formattedDate}</div>`:''}
      </div>
      <div class="meta">${source}${category?` ‚Ä¢ ${category}`:''}</div>
    </div>`;

  card.querySelector('a').addEventListener('click', e=>{
    e.preventDefault();
    const href = card.dataset.href || '';
    if (!href) { setStatus('‚ùå –õ–∏–ø—Å–≤–∞ –ª–∏–Ω–∫ –∫—ä–º —Å—Ç–∞—Ç–∏—è.'); return; }
    openReader(href);
  });

  return card;
}

async function importURL(url){
  if(!url){ setStatus('–ù–µ–≤–∞–ª–∏–¥–µ–Ω URL.'); return; }
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º –Ω–æ–≤–∏–Ω–∏‚Ä¶');
  try{
    const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res  = await fetch(prox, {mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const html = await res.text();
    const doc  = parseHTML(html);
    renderCardsFromDoc(doc, url);
    setStatus('');
  }catch(e){ setStatus('‚ùå CORS/HTTP –≥—Ä–µ—à–∫–∞: '+e.message); }
}

function renderCardsFromDoc(doc, baseHref){
  const raw = selectRawBlocks(doc);
  clearList();
  if(!raw.length){ placeholder('–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –µ–ª–µ–º–µ–Ω—Ç–∏.'); return; }
  raw.forEach(node => listEl.appendChild(toCardElement(node.outerHTML, baseHref)));
  populateCategories();
}

/* ===== Sidebar ===== */
async function loadSidebar(){
  try{
    const html = await fetch('sidebar.html').then(r=>r.text());
    sidebarEl.innerHTML = html;

    // 1) –ò–Ω–∂–µ–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ favicon –æ—Ç data-icon (–∞–∫–æ –∏–º–∞)
    sidebarEl.querySelectorAll('.cat,[data-url]').forEach(el=>{
      // –Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞–π –∫–ª–∞—Å .cat
      el.classList.add('cat');

      const labelText = (el.textContent||'').trim();
      if (!el.querySelector('.label')) {
        const span = document.createElement('span');
        span.className = 'label';
        span.textContent = labelText;
        el.innerHTML = ''; // –∏–∑—á–∏—Å—Ç–≤–∞–º–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–Ω–∏—è —Ç–µ–∫—Å—Ç
        // –¥–æ–±–∞–≤—è–º–µ –∏–∫–æ–Ω–∞—Ç–∞, –∞–∫–æ –∏–º–∞
        const iconUrl = el.getAttribute('data-icon');
        if (iconUrl) {
          const img = document.createElement('img');
          img.className = 'fav';
          img.alt = '';
          img.referrerPolicy = 'no-referrer';
          img.src = iconUrl; // –ª–∏–Ω–∫—ä—Ç —Å–µ –∑–∞–¥–∞–≤–∞ –≤ sidebar.html
          el.appendChild(img);
        }
        el.appendChild(span);
      }
      // –∑–∞–≥–ª–∞–≤–∏–µ –∑–∞ tooltip –ø—Ä–∏ —Å–≤–∏—Ç–æ –º–µ–Ω—é
      if (!el.title) el.title = labelText || el.getAttribute('data-url') || '';
    });

    // 2) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫ –ø–æ –µ–ª–µ–º–µ–Ω—Ç —Å data-url
    sidebarEl.addEventListener('click', e=>{
      const target = e.target.closest('[data-url]');
      if(!target) return;
      e.preventDefault();
      importURL(target.getAttribute('data-url'));
      // –º–æ–±–∏–ª–Ω–æ: –∑–∞—Ç–≤–æ—Ä–∏ off-canvas
      document.body.classList.remove('sidebar-open');
    });
  }catch{
    sidebarEl.innerHTML = '<div class="placeholder">‚ùå –ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è sidebar.html</div>';
  }
}
loadSidebar();

/* ===== –û—Ç–≤–∞—Ä—è–Ω–µ/—Å–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –º–µ–Ω—é ===== */
$('#menuToggle').addEventListener('click',()=>document.body.classList.toggle('sidebar-open'));

// –°–≤–∏–≤–∞–Ω–µ –≤ –º–∏–Ω–∏-—Ä–µ–π–ª (—Å–∞–º–æ –¥–µ—Å–∫—Ç–æ–ø): –ø–æ–∫–∞–∑–≤–∞ —Å–∞–º–æ —Ñ–∞–≤–∏–∫–æ–Ω–∏—Ç–µ, –∫–ª–∏–∫–∞–µ–º–∏
const collapseBtn = $('#collapseToggle');
collapseBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('sidebar-collapsed');
});

// –∫–ª–∏–∫ –∏–∑–≤—ä–Ω –º–µ–Ω—é—Ç–æ = –∑–∞—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ off-canvas (–º–æ–±–∏–ª–Ω–æ)
document.addEventListener('click',e=>{
  if(document.body.classList.contains('sidebar-open')){
    if(!$('#sidebar').contains(e.target)&&!$('#menuToggle').contains(e.target))
      document.body.classList.remove('sidebar-open');
  }
});

/* ===== –†–∞–∑–¥–µ–ª—è–Ω–µ –Ω–∞ –∞–±–∑–∞—Ü–∏ ===== */
function splitIntoSentenceParagraphs(text, groupSize = 3){
  const sentenceRegex = /[^.!?]+[.!?]+["']?\s*/g;
  const sentences = text.match(sentenceRegex) || [text];
  const groups = [];
  for (let i = 0; i < sentences.length; i += groupSize) {
    const group = sentences.slice(i, i + groupSize).join(' ').trim();
    if (group) groups.push(group);
  }
  return groups;
}

/* ===== Reader ===== */
const reader=$('#reader'), readerContent=$('#readerContent');
$('#readerClose').addEventListener('click',()=>{ reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; });
reader.addEventListener('click',e=>{ if(e.target.classList.contains('reader-backdrop')){ reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; } });

async function openReader(url){
  if (!url) { setStatus('‚ùå –ù–µ–≤–∞–ª–∏–¥–µ–Ω URL –∑–∞ —Å—Ç–∞—Ç–∏—è.'); return; }
  setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º —Å—Ç–∞—Ç–∏—è –∑–∞ —á–µ—Ç–µ–Ω–µ‚Ä¶');
  try{
    const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const res  = await fetch(prox, { mode:'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const html = await res.text();
    const doc  = parseHTML(html);

    // 1) JSON-LD (–≤–∫–ª. @graph)
    const fromLd = extractArticleFromLdJson(html);
    let articleText = fromLd?.body || null;
    let dateText    = fromLd?.date || '';

    // 2) Fallback –∫—ä–º –æ—Å–Ω–æ–≤–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!articleText) {
      const main = doc.querySelector('article, .article, .post-content, [itemprop="articleBody"]');
      if (main) { sanitize(main); articleText = main.innerText.trim(); }
    }

    // 3) –î–∞—Ç–∞ ‚Äì –∞–∫–æ –ª–∏–ø—Å–≤–∞
    if (!dateText) {
      const t = doc.querySelector('time[datetime], meta[property="article:published_time"]');
      dateText = t ? (t.getAttribute?.('datetime') || t.content || '') : '';
    }
    let fDate = '';
    if (dateText) {
      const d = new Date(dateText);
      if (!isNaN(d)) fDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'});
    }

    // 4) –ö–æ—Ä–∏—Ü–∞
    const pic = doc.querySelector('picture.img--title.landscape, article picture, .article picture, figure picture');
    const imgHTML = pic ? pic.outerHTML : '';

    if (articleText) {
      const paras = splitIntoSentenceParagraphs(articleText, 3);
      readerContent.innerHTML = `${imgHTML}${fDate?`<div class="reader-date">üïí ${fDate}</div>`:''}${paras.map((p,i)=>`<p class="${i===0?'lead':''}">${p}</p>`).join('')}`;
      reader.style.display='block';
      reader.setAttribute('aria-hidden','false');
      setStatus('');
    } else {
      setStatus('‚ùå –ù–µ —É—Å–ø—è—Ö –¥–∞ –∏–∑–≤–ª–µ–∫–∞ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ—Ç–æ –Ω–∞ —Å—Ç–∞—Ç–∏—è—Ç–∞.');
    }
  }catch(e){
    setStatus('‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ: '+e.message+' ‚Äî —Å–∞–π—Ç—ä—Ç –º–æ–∂–µ –¥–∞ –±–ª–æ–∫–∏—Ä–∞ –ø—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏.');
  }
}

/* ===== –§–∏–ª—Ç—Ä–∏ –ø–æ –≤—Ä–µ–º–µ ===== */
document.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); applyDateFilter(b.dataset.filter);
}));
function applyDateFilter(f){
  const now=new Date();
  document.querySelectorAll('.card-row').forEach(c=>{
    const dStr=c.dataset.date; if(!dStr){ c.style.display=''; return; }
    const d=new Date(dStr); let show=true;
    if(f==='today') show = d.toDateString()===now.toDateString();
    else if(f==='week') show = (now-d)/(1000*60*60*24)<=7;
    else if(f==='month') show = (now-d)/(1000*60*60*24)<=31;
    c.style.display = show ? '' : 'none';
  });
}

/* ===== –§–∏–ª—Ç—ä—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è ===== */
const catSel=$('#categorySelect');
function populateCategories(){
  const cats=new Set();
  document.querySelectorAll('.card-row[data-category]').forEach(c=>{ if(c.dataset.category) cats.add(c.dataset.category); });
  catSel.innerHTML='<option value="all">–í—Å–∏—á–∫–∏</option>'+[...cats].sort().map(c=>`<option>${c}</option>`).join('');
}
catSel.addEventListener('change',()=>{
  const sel=catSel.value;
  document.querySelectorAll('.card-row').forEach(c=>{
    c.style.display=(sel==='all'||c.dataset.category===sel)?'':'none';
  });
});

/* ===== –°–∫—Ä–∏–π ‚Äû–ü–æ—Å–ª–µ–¥–Ω–∏ –Ω–æ–≤–∏–Ω–∏‚Äú –ø—Ä–∏ —Å–∫—Ä–æ–ª –Ω–∞–¥–æ–ª—É ===== */
let lastScrollTop = 0;
mainEl.addEventListener('scroll', ()=>{
  const st = mainEl.scrollTop;
  if (st > lastScrollTop && st > 30) {
    document.body.classList.add('scrolling-down');
  } else {
    document.body.classList.remove('scrolling-down');
  }
  lastScrollTop = st <= 0 ? 0 : st;
});
</script>
</body>
</html>