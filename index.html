<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏ ‚Äî –∏–∑–≤–ª–∏—á–∞–Ω–µ –∏ –ø–ª–æ—Å—ä–∫ –¥–∏–∑–∞–π–Ω</title>
<link rel="stylesheet" href="style.css">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f1418">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body>
  <div class="app">
    <!-- Off-canvas sidebar (solid bg –Ω–∞ –º–æ–±–∏–ª–Ω–æ) -->
    <aside id="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div>
      <div style="color:#999">–ó–∞—Ä–µ–∂–¥–∞–º –º–µ–Ω—é...</div>
    </aside>

    <main>
      <!-- Pull-to-refresh indicator -->
      <div id="ptr" aria-hidden="true">
        <div class="ptr-inner">
          <span class="ptr-icon">‚Üì</span>
          <span class="ptr-text">–ò–∑—Ç–µ–≥–ª–∏ –∑–∞ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ</span>
        </div>
      </div>

      <!-- Top bar -->
      <div class="top">
        <button id="menuToggle" class="icon-btn" aria-label="–û—Ç–≤–æ—Ä–∏ –º–µ–Ω—é">‚ò∞</button>

        <form class="import" onsubmit="return false;">
          <input id="urlInput" type="url" inputmode="url" placeholder="–í—ä–≤–µ–¥–∏ URL (allorigins)" autocomplete="off">
          <button id="btnFetch" class="btn primary">–ò–∑–≤–ª–µ—á–∏</button>
        </form>

        <div class="import-actions">
          <label class="btn file-btn">
            –ö–∞—á–∏ .html
            <input id="fileInput" type="file" accept=".html,.htm,text/html" hidden>
          </label>
          <button id="btnPaste" class="btn">–ü–æ—Å—Ç–∞–≤–∏ HTML</button>
        </div>
      </div>

      <div id="status" class="status"></div>

      <!-- Filters -->
      <section class="filters">
        <div class="time-filters scroller">
          <button class="chip" data-filter="today">–î–Ω–µ—Å</button>
          <button class="chip" data-filter="week">–¢–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</button>
          <button class="chip" data-filter="month">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</button>
          <button class="chip active" data-filter="all">–í—Å–∏—á–∫–∏</button>
        </div>
        <div class="category-filter">
          <label for="categorySelect" class="cat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categorySelect">
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>
      </section>

      <!-- News list -->
      <div id="list" class="list">
        <div class="placeholder">
          –ò–∑–ø–æ–ª–∑–≤–∞–π URL/–ö–∞—á–∏/–ü–æ—Å—Ç–∞–≤–∏ HTML –∏–ª–∏ <b>–º–µ–Ω—é—Ç–æ</b>. –©–µ —Å–µ –∏–∑–≤–∞–¥—è—Ç
          <code>div.card.pt-4.pb-4.ad0</code> –∏ <code>div.card.pt-4.pb-4.ad3</code>.
        </div>
      </div>
    </main>
  </div>

  <!-- Reader overlay -->
  <div id="reader" class="reader" style="display:none" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="reader-backdrop"></div>
    <div class="reader-panel">
      <div class="reader-bar">
        <div class="reader-title">–ß–µ—Ç–µ—Ü</div>
        <div class="reader-actions">
          <button id="readerClose" class="btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
      <div id="readerContent" class="reader-content"></div>
    </div>
  </div>

<script>
  // ===== Theme (dark by default)
  function setTheme(isDark){ document.body.classList.toggle('light', !isDark); localStorage.setItem('theme', isDark?'dark':'light'); }
  (function initTheme(){ const saved=localStorage.getItem('theme'); setTheme(saved!=='light'); })();

  // ===== Helpers
  const $ = s => document.querySelector(s);
  const statusEl = $('#status'), listEl = $('#list'), sidebarEl = $('#sidebar');
  function setStatus(msg){ statusEl.textContent = msg || ''; }
  function clearList(){ listEl.innerHTML=''; }
  function placeholder(msg){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML=msg; listEl.appendChild(d); }
  function parseHTML(html){ return new DOMParser().parseFromString(html,'text/html'); }
  function absURL(base, rel){ try{ return new URL(rel, base).href }catch{ return rel } }
  function sanitize(node){ node.querySelectorAll('script,style,iframe,object,embed,noscript').forEach(n=>n.remove()); return node; }
  function fixRelativeURLs(node, baseHref){
    node.querySelectorAll('[href]').forEach(a=> a.setAttribute('href', absURL(baseHref, a.getAttribute('href'))));
    node.querySelectorAll('[src]').forEach(el=> el.setAttribute('src', absURL(baseHref, el.getAttribute('src'))));
    node.querySelectorAll('[srcset]').forEach(el=>{
      const parts=(el.getAttribute('srcset')||'').split(',').map(s=>s.trim()).filter(Boolean);
      el.setAttribute('srcset', parts.map(p=>{const [u,d]=p.split(/\s+/); return absURL(baseHref,u)+(d?(' '+d):'')}).join(', '));
    });
    return node;
  }

  // ===== Select & build cards
  function selectRawBlocks(doc){
    return Array.from(doc.querySelectorAll('div.card.pt-4.pb-4.ad0, div.card.pt-4.pb-4.ad3'));
  }

  function toCardElement(rawHTML, baseHref){
    const fragDoc = parseHTML('<div id="wrap">'+rawHTML+'</div>');
    const wrap = fragDoc.getElementById('wrap');
    sanitize(wrap);
    fixRelativeURLs(wrap, baseHref);

    // thumb
    let imgSrc = null;
    const img = wrap.querySelector('img');
    if(img && img.getAttribute('src')) imgSrc = img.getAttribute('src');

    // title & link
    let title = '', link = '';
    const h = wrap.querySelector('h1, h2, h3');
    if(h && h.textContent.trim()){
      title = h.textContent.trim();
      const aInH = h.querySelector('a[href]');
      if(aInH) link = aInH.getAttribute('href');
    }else{
      const a = wrap.querySelector('a[href]');
      if(a && a.textContent.trim()){ title = a.textContent.trim(); link = a.getAttribute('href'); }
      else{ const p = wrap.querySelector('p, div'); title = (p && p.textContent.trim()) ? p.textContent.trim().slice(0,160) : '(–±–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ)'; }
    }

    // date
    let dateText = '';
    const t = wrap.querySelector('time[datetime]') || wrap.querySelector('meta[property="article:published_time"]');
    if(t){ dateText = t.getAttribute('datetime') || t.content || ''; }
    else { const dateEl = wrap.querySelector('span.date, div.date'); if(dateEl) dateText = dateEl.textContent.trim(); }

    let formattedDate = '', isoDate = '';
    if(dateText){
      try{
        const d = new Date(dateText);
        if(!isNaN(d)) { formattedDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'}); isoDate = d.toISOString(); }
        else formattedDate = dateText;
      }catch{ formattedDate = dateText; }
    }

    // source
    let source = '';
    try{ source = new URL(baseHref).hostname.replace(/^www\./,''); }catch{}
    const meta = source || '';

    // category from breadcrumb
    const breadcrumb = wrap.querySelector('li.breadcrumb-item.d-lg-inline.mb-1');
    const category = breadcrumb ? breadcrumb.textContent.trim() : '';

    // render
    const card = document.createElement('div'); 
    card.className = 'card-row';
    if(isoDate) card.dataset.date = isoDate;
    if(category) card.dataset.category = category;

    const thumb = document.createElement('div'); 
    thumb.className = 'thumb';
    if(imgSrc){ const im=document.createElement('img'); im.loading='lazy'; im.src=imgSrc; thumb.appendChild(im); }
    else { thumb.textContent='no image'; }

    const right = document.createElement('div'); right.className = 'right-side';
    const headerRow = document.createElement('div'); headerRow.className = 'header-row';

    const titleEl = document.createElement('h3'); titleEl.className='title';
    if(link){
      const a = document.createElement('a');
      a.href = link; a.textContent = title; a.target = '_blank'; a.rel='noopener';
      a.style.color='inherit'; a.style.textDecoration='none';
      a.addEventListener('click', (ev)=>{ ev.preventDefault(); openReader(link); });
      titleEl.appendChild(a);
    } else { titleEl.textContent = title; }

    const dateEl = document.createElement('div');
    dateEl.className = 'meta-date';
    dateEl.textContent = formattedDate ? `üïí ${formattedDate}` : '';

    headerRow.appendChild(titleEl);
    if(formattedDate) headerRow.appendChild(dateEl);

    const metaEl = document.createElement('div');
    metaEl.className='meta';
    metaEl.textContent = meta + (category ? ` ‚Ä¢ ${category}` : '');

    right.appendChild(headerRow);
    right.appendChild(metaEl);
    card.appendChild(thumb);
    card.appendChild(right);
    return card;
  }

  // ===== Importers
  async function importURL(url){
    if(!url){ setStatus('–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ URL.'); return; }
    setStatus('‚è≥ –¢–µ–≥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–∑ allorigins‚Ä¶');
    try{
      const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(prox, {mode:'cors'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const html = await res.text();
      const doc = parseHTML(html);
      renderCardsFromDoc(doc, url);
      setStatus('‚úÖ –ì–æ—Ç–æ–≤–æ.');
    }catch(e){
      setStatus('‚ùå CORS/HTTP –≥—Ä–µ—à–∫–∞. –ü–æ–ª–∑–≤–∞–π ‚Äû–ö–∞—á–∏ .html‚Äú –∏–ª–∏ ‚Äû–ü–æ—Å—Ç–∞–≤–∏ HTML‚Äú. ('+e.message+')');
    }
  }

  document.getElementById('btnFetch').addEventListener('click',()=> importURL(document.getElementById('urlInput').value.trim()));
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const html = await f.text(); const doc = parseHTML(html);
    renderCardsFromDoc(doc, 'file:///'+(f.name||'index.html')); setStatus('‚úÖ –ö–∞—á–µ–Ω —Ñ–∞–π–ª.'); e.target.value='';
  });
  document.getElementById('btnPaste').addEventListener('click', async ()=>{
    try{ const text = await navigator.clipboard.readText(); if(!text || !text.includes('<')){ setStatus('–ë—É—Ñ–µ—Ä—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ HTML.'); return; }
      const doc = parseHTML(text); renderCardsFromDoc(doc, location.href); setStatus('‚úÖ –ü–æ—Å—Ç–∞–≤–µ–Ω HTML.');
    }catch(e){ setStatus('‚ùå –ù—è–º–∞–º –¥–æ—Å—Ç—ä–ø –¥–æ –∫–ª–∏–ø–±–æ—Ä–¥–∞.'); }
  });

  // ===== Sidebar load + mobile toggle (solid bg –Ω–∞ –º–æ–±–∏–ª–Ω–æ)
  async function loadSidebar(){
    try{
      const html = await fetch('sidebar.html').then(r=>r.text());
      sidebarEl.innerHTML = html;
      sidebarEl.addEventListener('click', (ev)=>{
        const target = ev.target.closest('[data-url]');
        if(!target) return;
        ev.preventDefault();
        importURL(target.getAttribute('data-url'));
        document.body.classList.remove('sidebar-open');
      });
    }catch(e){
      sidebarEl.innerHTML = '<div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div><div class="placeholder">–ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è sidebar.html</div>';
    }
  }
  loadSidebar();

  const menuToggle = document.getElementById('menuToggle');
  menuToggle.addEventListener('click', ()=> document.body.classList.toggle('sidebar-open'));
  document.addEventListener('click', (e)=>{
    if(document.body.classList.contains('sidebar-open')){
      const sb = document.getElementById('sidebar');
      if(!sb.contains(e.target) && !menuToggle.contains(e.target)){ document.body.classList.remove('sidebar-open'); }
    }
  });

  // ===== Reader
  const reader = document.getElementById('reader'), readerContent = document.getElementById('readerContent');
  document.getElementById('readerClose').addEventListener('click', ()=>{ reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; });
  reader.addEventListener('click', (e)=>{ if(e.target.classList.contains('reader-backdrop')) { reader.style.display='none'; reader.setAttribute('aria-hidden','true'); readerContent.innerHTML=''; } });

  function splitIntoSentenceParagraphs(text, groupSize = 3){
    const sentenceRegex = /[^.!?]+[.!?]+["']?\s*/g;
    const sentences = text.match(sentenceRegex) || [text];
    const groups = [];
    for (let i=0; i<sentences.length; i+=groupSize){
      const group = sentences.slice(i, i+groupSize).join(' ').trim();
      if (group) groups.push(group);
    }
    return groups;
  }

  async function openReader(url){
    setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º —Å—Ç–∞—Ç–∏—è –∑–∞ —á–µ—Ç–µ–Ω–µ‚Ä¶');
    try{
      const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(prox, {mode:'cors'});
      const html = await res.text();
      const doc = parseHTML(html);
      const pic = doc.querySelector('picture.img--title.landscape');
      let imgHTML = pic ? pic.outerHTML : '';
      let dateText = '';
      const ld = html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);
      let articleText=null;
      if(ld){
        for(let m of ld){
          try{
            const j = JSON.parse(m.match(/<script[^>]*>([\s\S]*?)<\/script>/i)[1]);
            const pick = o=>o?.dateModified||o?.datePublished||null;
            if(Array.isArray(j)){for(let i of j){if(i.articleBody){articleText=i.articleBody;dateText=pick(i);break;}}}
            else if(j.articleBody){articleText=j.articleBody;dateText=pick(j);}
          }catch{}
          if(articleText) break;
        }
      }
      if(!dateText){const t=doc.querySelector('time[datetime]');if(t)dateText=t.getAttribute('datetime');}
      let fDate='';if(dateText){try{const d=new Date(dateText);if(!isNaN(d))fDate=d.toLocaleString('bg-BG',{dateStyle:'medium',timeStyle:'short'});}catch{}}
      if(articleText){
        const g=splitIntoSentenceParagraphs(articleText,3);
        readerContent.innerHTML=`${imgHTML}${fDate?`<div class="reader-date">üïí ${fDate}</div>`:''}${g.map((x,i)=>`<p class="${i===0?'lead':''}">${x}</p>`).join('')}`;
        reader.style.display='block'; reader.setAttribute('aria-hidden','false');
      }
    }catch(e){ setStatus('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message); }
  }

  // ===== Time filters
  const filterButtons = document.querySelectorAll('.chip');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      applyDateFilter(btn.dataset.filter);
    });
  });

  function applyDateFilter(filter){
    const now = new Date();
    const cards = document.querySelectorAll('.card-row');
    cards.forEach(card => {
      const dateStr = card.dataset.date;
      if(!dateStr){ card.style.display = ''; return; }
      const date = new Date(dateStr);
      let show = true;
      if(filter === 'today'){
        show = date.toDateString() === now.toDateString();
      } else if(filter === 'week'){
        const diff = (now - date) / (1000*60*60*24);
        show = diff <= 7;
      } else if(filter === 'month'){
        const diff = (now - date) / (1000*60*60*24);
        show = diff <= 31;
      }
      card.style.display = show ? '' : 'none';
    });
  }

  // ===== Category filter
  const categorySelect = document.getElementById('categorySelect');
  function populateCategories(){
    const categories = new Set();
    document.querySelectorAll('.card-row[data-category]').forEach(c=>{
      const cat = c.dataset.category;
      if(cat) categories.add(cat);
    });
    categorySelect.innerHTML = '<option value="all">–í—Å–∏—á–∫–∏</option>' + 
      Array.from(categories).sort().map(c=>`<option value="${c}">${c}</option>`).join('');
  }
  categorySelect.addEventListener('change', ()=>{
    const selected = categorySelect.value;
    document.querySelectorAll('.card-row').forEach(c=>{
      const cat = c.dataset.category || '';
      c.style.display = (selected==='all' || cat===selected) ? '' : 'none';
    });
  });

  function renderCardsFromDoc(doc, baseHref){
    const raw = selectRawBlocks(doc);
    clearList();
    if(!raw.length){ placeholder('–ù–∏—â–æ –Ω–µ –µ –æ—Ç–∫—Ä–∏—Ç–æ –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏—Ç–µ.'); return; }
    raw.forEach(node=>{
      const card = toCardElement(node.outerHTML, baseHref);
      listEl.appendChild(card);
    });
    populateCategories();
  }

  // ===== PWA: Service Worker & Pull-to-refresh =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  }
  let lastSourceUrl = localStorage.getItem('lastSourceUrl') || '';
  const rememberSource = (url)=>{ if(url){ lastSourceUrl=url; localStorage.setItem('lastSourceUrl', url);} };
  const _importURL = importURL;
  importURL = async function(url){ rememberSource(url); return _importURL(url); };
  document.addEventListener('click', (e)=>{
    const n = e.target.closest('#sidebar [data-url]');
    if(n){ rememberSource(n.getAttribute('data-url')); }
  }, true);

  (function setupPTR(){
    const ptr = document.getElementById('ptr');
    const THRESHOLD = 70, MAX_PULL = 120;
    let startY = 0, pulling = false, triggered = false;
    const isTop = ()=> (window.scrollY === 0);
    function onStart(e){ if(!isTop()||e.touches.length!==1) return; startY=e.touches[0].clientY; pulling=true; triggered=false; ptr.style.transition='none'; }
    function onMove(e){
      if(!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if(dy <= 0){ reset(); return; }
      e.preventDefault();
      const pull = Math.min(dy, MAX_PULL);
      ptr.style.transform = `translateY(${pull}px)`;
      ptr.classList.toggle('armed', pull > THRESHOLD);
    }
    async function onEnd(){
      if(!pulling) return;
      const pulled = parseInt((ptr.style.transform.match(/translateY\((\d+)/)||[0,0])[1],10)||0;
      if(pulled > THRESHOLD && !triggered){
        triggered = true; ptr.classList.add('loading'); ptr.querySelector('.ptr-icon').textContent='‚ü≥';
        try{ if(lastSourceUrl){ await importURL(lastSourceUrl); } } finally { setTimeout(reset, 400); }
      } else { reset(); }
    }
    function reset(){ pulling=false; ptr.style.transition='transform .25s ease'; ptr.style.transform='translateY(0)'; ptr.classList.remove('armed','loading'); ptr.querySelector('.ptr-icon').textContent='‚Üì'; }
    document.addEventListener('touchstart', onStart, {passive:false});
    document.addEventListener('touchmove',  onMove,  {passive:false});
    document.addEventListener('touchend',   onEnd,   {passive:true});
  })();
</script>
</body>
</html>