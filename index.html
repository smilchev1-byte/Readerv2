<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>–ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏ ‚Äî –∏–∑–≤–ª–∏—á–∞–Ω–µ –∏ –ø–ª–æ—Å—ä–∫ –¥–∏–∑–∞–π–Ω</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <aside id="sidebar">
      <div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div>
      <div style="color:#999">–ó–∞—Ä–µ–∂–¥–∞–º –º–µ–Ω—é...</div>
    </aside>

    <main>
      <div class="top">
        <form class="import" onsubmit="return false;">
          <input id="urlInput" type="url" placeholder="–í—ä–≤–µ–¥–∏ URL (—â–µ —Å–µ –∏–∑–≤–ª–µ—á–µ –ø—Ä–µ–∑ allorigins)">
          <button id="btnFetch" class="btn primary">–ò–∑–≤–ª–µ—á–∏</button>
        </form>
        <label class="btn" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer;">
          –ö–∞—á–∏ .html <input id="fileInput" type="file" accept=".html,.htm,text/html" hidden>
        </label>
        <button id="btnPaste" class="btn">–ü–æ—Å—Ç–∞–≤–∏ HTML</button>
      </div>
      <div id="status" class="status"></div>

      <section class="filters">
        <div class="time-filters">
          <button class="chip" data-filter="today">–î–Ω–µ—Å</button>
          <button class="chip" data-filter="week">–¢–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞</button>
          <button class="chip" data-filter="month">–¢–æ–∑–∏ –º–µ—Å–µ—Ü</button>
          <button class="chip active" data-filter="all">–í—Å–∏—á–∫–∏</button>
        </div>
        <div class="category-filter">
          <label for="categorySelect" class="cat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
          <select id="categorySelect">
            <option value="all">–í—Å–∏—á–∫–∏</option>
          </select>
        </div>
      </section>

      <div id="list" class="list">
        <div class="placeholder">
          –ò–∑–ø–æ–ª–∑–≤–∞–π URL/–ö–∞—á–∏/–ü–æ—Å—Ç–∞–≤–∏ HTML –∏–ª–∏ <b>–º–µ–Ω—é—Ç–æ –≤–ª—è–≤–æ</b>. –©–µ —Å–µ –∏–∑–≤–∞–¥—è—Ç <code>div.card.pt-4.pb-4.ad0</code> –∏ <code>div.card.pt-4.pb-4.ad3</code>.
        </div>
      </div>
    </main>
  </div>

  <!-- Reader overlay -->
  <div id="reader" style="display:none">
    <div class="reader-backdrop"></div>
    <div class="reader-panel">
      <div class="reader-bar">
        <div class="reader-title">–ß–µ—Ç–µ—Ü</div>
        <div class="reader-actions">
          <button id="readerClose" class="btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
      <div id="readerContent" class="reader-content"></div>
    </div>
  </div>

<script>
  // ===== –¢–µ–º–∞ (—Ç—ä–º–Ω–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ)
  function setTheme(isDark){ document.body.classList.toggle('light', !isDark); localStorage.setItem('theme', isDark?'dark':'light'); }
  (function initTheme(){ const saved=localStorage.getItem('theme'); setTheme(saved!=='light'); })();

  // ===== –ü–æ–º–æ—â–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏
  const $ = s => document.querySelector(s);
  const statusEl = $('#status'), listEl = $('#list'), sidebarEl = $('#sidebar');
  function setStatus(msg){ statusEl.textContent = msg || ''; }
  function clearList(){ listEl.innerHTML=''; }
  function placeholder(msg){ const d=document.createElement('div'); d.className='placeholder'; d.innerHTML=msg; listEl.appendChild(d); }
  function parseHTML(html){ return new DOMParser().parseFromString(html,'text/html'); }
  function absURL(base, rel){ try{ return new URL(rel, base).href }catch{ return rel } }

  function sanitize(node){
    node.querySelectorAll('script,style,iframe,object,embed,noscript').forEach(n=>n.remove());
    return node;
  }
  function fixRelativeURLs(node, baseHref){
    node.querySelectorAll('[href]').forEach(a=> a.setAttribute('href', absURL(baseHref, a.getAttribute('href'))));
    node.querySelectorAll('[src]').forEach(el=> el.setAttribute('src', absURL(baseHref, el.getAttribute('src'))));
    node.querySelectorAll('[srcset]').forEach(el=>{
      const parts=(el.getAttribute('srcset')||'').split(',').map(s=>s.trim()).filter(Boolean);
      el.setAttribute('srcset', parts.map(p=>{const [u,d]=p.split(/\s+/); return absURL(baseHref,u)+(d?(' '+d):'')}).join(', '));
    });
    return node;
  }

  function selectRawBlocks(doc){
    return Array.from(doc.querySelectorAll('div.card.pt-4.pb-4.ad0, div.card.pt-4.pb-4.ad3'));
  }

  function toCardElement(rawHTML, baseHref){
    const fragDoc = parseHTML('<div id="wrap">'+rawHTML+'</div>');
    const wrap = fragDoc.getElementById('wrap');
    sanitize(wrap);
    fixRelativeURLs(wrap, baseHref);

    // thumbnail
    let imgSrc = null;
    const img = wrap.querySelector('img');
    if(img && img.getAttribute('src')) imgSrc = img.getAttribute('src');

    // title & link
    let title = '';
    let link = '';
    const h = wrap.querySelector('h1, h2, h3');
    if(h && h.textContent.trim()){
      title = h.textContent.trim();
      const aInH = h.querySelector('a[href]');
      if(aInH) link = aInH.getAttribute('href');
    }else{
      const a = wrap.querySelector('a[href]');
      if(a && a.textContent.trim()){
        title = a.textContent.trim();
        link = a.getAttribute('href');
      }else{
        const p = wrap.querySelector('p, div');
        title = (p && p.textContent.trim()) ? p.textContent.trim().slice(0,160) : '(–±–µ–∑ –∑–∞–≥–ª–∞–≤–∏–µ)';
      }
    }

    // üïí –¥–∞—Ç–∞
    let dateText = '';
    const t = wrap.querySelector('time[datetime]') || wrap.querySelector('meta[property="article:published_time"]');
    if(t){ dateText = t.getAttribute('datetime') || t.content || ''; }
    else { const dateEl = wrap.querySelector('span.date, div.date'); if(dateEl) dateText = dateEl.textContent.trim(); }

    let formattedDate = '', isoDate = '';
    if(dateText){
      try{
        const d = new Date(dateText);
        if(!isNaN(d)) {
          formattedDate = d.toLocaleString('bg-BG',{dateStyle:'medium', timeStyle:'short'});
          isoDate = d.toISOString();
        } else formattedDate = dateText;
      }catch{ formattedDate = dateText; }
    }

    // üåê –∏–∑—Ç–æ—á–Ω–∏–∫
    let source = '';
    try{ source = new URL(baseHref).hostname.replace(/^www\./,''); }catch{}
    const meta = source || '';

    // üè∑Ô∏è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
    const breadcrumb = wrap.querySelector('li.breadcrumb-item.d-lg-inline.mb-1');
    const category = breadcrumb ? breadcrumb.textContent.trim() : '';

    // render
    const card = document.createElement('div'); 
    card.className = 'card-row';
    if(isoDate) card.dataset.date = isoDate;
    if(category) card.dataset.category = category;

    const thumb = document.createElement('div'); 
    thumb.className = 'thumb';
    if(imgSrc){ const im=document.createElement('img'); im.loading='lazy'; im.src=imgSrc; thumb.appendChild(im); }
    else { thumb.textContent='no image'; }

    const right = document.createElement('div'); right.className = 'right-side';
    const headerRow = document.createElement('div'); headerRow.className = 'header-row';

    const titleEl = document.createElement('h3'); titleEl.className='title';
    if(link){
      const a = document.createElement('a');
      a.href = link; a.textContent = title; a.target = '_blank'; a.rel='noopener';
      a.style.color='inherit'; a.style.textDecoration='none';
      a.addEventListener('click', (ev)=>{ ev.preventDefault(); openReader(link); });
      titleEl.appendChild(a);
    } else { titleEl.textContent = title; }

    const dateEl = document.createElement('div');
    dateEl.className = 'meta-date';
    dateEl.textContent = formattedDate ? `üïí ${formattedDate}` : '';

    headerRow.appendChild(titleEl);
    if(formattedDate) headerRow.appendChild(dateEl);

    const metaEl = document.createElement('div');
    metaEl.className='meta';
    metaEl.textContent = meta + (category ? ` ‚Ä¢ ${category}` : '');

    right.appendChild(headerRow);
    right.appendChild(metaEl);
    card.appendChild(thumb);
    card.appendChild(right);
    return card;
  }

  // ===== –ò–∑–≤–ª–∏—á–∞–Ω–µ –æ—Ç URL / —Ñ–∞–π–ª / HTML =====
  async function importURL(url){
    if(!url){ setStatus('–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ URL.'); return; }
    setStatus('‚è≥ –¢–µ–≥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–∑ allorigins‚Ä¶');
    try{
      const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(prox, {mode:'cors'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const html = await res.text();
      const doc = parseHTML(html);
      renderCardsFromDoc(doc, url);
      setStatus('‚úÖ –ì–æ—Ç–æ–≤–æ.');
    }catch(e){
      setStatus('‚ùå CORS/HTTP –≥—Ä–µ—à–∫–∞. –ü–æ–ª–∑–≤–∞–π ‚Äû–ö–∞—á–∏ .html‚Äú –∏–ª–∏ ‚Äû–ü–æ—Å—Ç–∞–≤–∏ HTML‚Äú. ('+e.message+')');
    }
  }

  $('#btnFetch').addEventListener('click',()=> importURL($('#urlInput').value.trim()));
  $('#fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    const html = await f.text();
    const doc = parseHTML(html);
    renderCardsFromDoc(doc, 'file:///'+(f.name||'index.html'));
    setStatus('‚úÖ –ö–∞—á–µ–Ω —Ñ–∞–π–ª.');
    e.target.value='';
  });
  $('#btnPaste').addEventListener('click', async ()=>{
    try{
      const text = await navigator.clipboard.readText();
      if(!text || !text.includes('<')){ setStatus('–ë—É—Ñ–µ—Ä—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ HTML.'); return; }
      const doc = parseHTML(text);
      renderCardsFromDoc(doc, location.href);
      setStatus('‚úÖ –ü–æ—Å—Ç–∞–≤–µ–Ω HTML.');
    }catch(e){ setStatus('‚ùå –ù—è–º–∞–º –¥–æ—Å—Ç—ä–ø –¥–æ –∫–ª–∏–ø–±–æ—Ä–¥–∞.'); }
  });

  // ===== Sidebar
  async function loadSidebar(){
    try{
      const html = await fetch('sidebar.html').then(r=>r.text());
      sidebarEl.innerHTML = html;
      sidebarEl.addEventListener('click', (ev)=>{
        const target = ev.target.closest('[data-url]');
        if(!target) return;
        ev.preventDefault();
        importURL(target.getAttribute('data-url'));
      });
    }catch(e){
      sidebarEl.innerHTML = '<div class="brand">üì∞ –ú–æ–∏—Ç–µ –Ω–æ–≤–∏–Ω–∏</div><div class="placeholder">–ù–µ —É—Å–ø—è—Ö –¥–∞ –∑–∞—Ä–µ–¥—è sidebar.html</div>';
    }
  }
  loadSidebar();

  // ===== Reader
  const reader = $('#reader'), readerContent = $('#readerContent');
  $('#readerClose').addEventListener('click', ()=>{ reader.style.display='none'; readerContent.innerHTML=''; });
  reader.addEventListener('click', (e)=>{ if(e.target.classList.contains('reader-backdrop')) { reader.style.display='none'; readerContent.innerHTML=''; } });

  function splitIntoSentenceParagraphs(text, groupSize = 3){
    const sentenceRegex = /[^.!?]+[.!?]+["']?\s*/g;
    const sentences = text.match(sentenceRegex) || [text];
    const groups = [];
    for (let i=0; i<sentences.length; i+=groupSize){
      const group = sentences.slice(i, i+groupSize).join(' ').trim();
      if (group) groups.push(group);
    }
    return groups;
  }

  async function openReader(url){
    setStatus('‚è≥ –ó–∞—Ä–µ–∂–¥–∞–º —Å—Ç–∞—Ç–∏—è –∑–∞ —á–µ—Ç–µ–Ω–µ‚Ä¶');
    try{
      const prox = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
      const res = await fetch(prox, {mode:'cors'});
      const html = await res.text();
      const doc = parseHTML(html);
      const pic = doc.querySelector('picture.img--title.landscape');
      let imgHTML = pic ? pic.outerHTML : '';
      let dateText = '';
      const ld = html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);
      let articleText=null;
      if(ld){
        for(let m of ld){
          try{
            const j = JSON.parse(m.match(/<script[^>]*>([\s\S]*?)<\/script>/i)[1]);
            const pick = o=>o?.dateModified||o?.datePublished||null;
            if(Array.isArray(j)){for(let i of j){if(i.articleBody){articleText=i.articleBody;dateText=pick(i);break;}}}
            else if(j.articleBody){articleText=j.articleBody;dateText=pick(j);}
          }catch{}
          if(articleText) break;
        }
      }
      if(!dateText){const t=doc.querySelector('time[datetime]');if(t)dateText=t.getAttribute('datetime');}
      let fDate='';if(dateText){try{const d=new Date(dateText);if(!isNaN(d))fDate=d.toLocaleString('bg-BG',{dateStyle:'medium',timeStyle:'short'});}catch{}}
      if(articleText){const g=splitIntoSentenceParagraphs(articleText,3);readerContent.innerHTML=`${imgHTML}${fDate?`<div class="reader-date">üïí ${fDate}</div>`:''}${g.map((x,i)=>`<p class="${i===0?'lead':''}">${x}</p>`).join('')}`;reader.style.display='block';}
    }catch(e){setStatus('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}
  }

  // ===== –§–∏–ª—Ç—Ä–∏ –ø–æ –≤—Ä–µ–º–µ
  const filterButtons = document.querySelectorAll('.chip');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      applyDateFilter(btn.dataset.filter);
    });
  });

  function applyDateFilter(filter){
    const now = new Date();
    const cards = document.querySelectorAll('.card-row');
    cards.forEach(card => {
      const dateStr = card.dataset.date;
      if(!dateStr){ card.style.display = ''; return; }
      const date = new Date(dateStr);
      let show = true;
      if(filter === 'today'){
        show = date.toDateString() === now.toDateString();
      } else if(filter === 'week'){
        const diff = (now - date) / (1000*60*60*24);
        show = diff <= 7;
      } else if(filter === 'month'){
        const diff = (now - date) / (1000*60*60*24);
        show = diff <= 31;
      }
      card.style.display = show ? '' : 'none';
    });
  }

  // ===== –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è =====
  const categorySelect = document.getElementById('categorySelect');
  function populateCategories(){
    const categories = new Set();
    document.querySelectorAll('.card-row[data-category]').forEach(c=>{
      const cat = c.dataset.category;
      if(cat) categories.add(cat);
    });
    categorySelect.innerHTML = '<option value="all">–í—Å–∏—á–∫–∏</option>' + 
      Array.from(categories).map(c=>`<option value="${c}">${c}</option>`).join('');
  }

  categorySelect.addEventListener('change', ()=>{
    const selected = categorySelect.value;
    document.querySelectorAll('.card-row').forEach(c=>{
      const cat = c.dataset.category || '';
      c.style.display = (selected==='all' || cat===selected) ? '' : 'none';
    });
  });

  function renderCardsFromDoc(doc, baseHref){
    const raw = selectRawBlocks(doc);
    clearList();
    if(!raw.length){ placeholder('–ù–∏—â–æ –Ω–µ –µ –æ—Ç–∫—Ä–∏—Ç–æ –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏—Ç–µ.'); return; }
    raw.forEach(node=>{
      const card = toCardElement(node.outerHTML, baseHref);
      listEl.appendChild(card);
    });
    populateCategories();
  }
</script>
</body>
</html>
